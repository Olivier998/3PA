DROP TABLE IF EXISTS eicu_crd.sapsii_Data_24; CREATE TABLE eicu_crd.sapsii_Data_24 AS 

-- ------------------------------------------------------------------
-- Title: Simplified Acute Physiology Score II (SAPS II)
-- This query extracts the simplified acute physiology score II.
-- This score is a measure of patient severity of illness.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for SAPS II:
--    Le Gall, Jean-Roger, Stanley Lemeshow, and Fabienne Saulnier.
--    "A new simplified acute physiology score (SAPS II) based on a European/North American multicenter study."
--    JAMA 270, no. 24 (1993): 2957-2963.

-- Variables used in SAPS II:
--  Age, GCS
--  VITALS: Heart rate, systolic blood pressure, temperature
--  FLAGS: ventilation/cpap
--  IO: urine output
--  LABS: PaO2/FiO2 ratio, blood urea nitrogen, WBC, potassium, sodium, HCO3


-- Patients information
with pat_info as
(
	select patientunitstayid
			, patientHealthSystemStayID
			, uniquepid
		   	, case 	when age = '> 89' then 91 
				  	when age = '' then 0
				  	else cast(age as int)  end as age
			, hospitalid
			, case  when unitdischargestatus = 'Alive' then 0
					when unitdischargestatus = 'Expired' then 1
					else null end as deceased_unit
			, case  when hospitaldischargestatus = 'Alive' then 0
					when hospitaldischargestatus = 'Expired' then 1
					else null end as deceased_hosp
			, unitdischargeoffset as stay_length
			, 0 as organdonor -- case when hospitaldischargeoffset <= 0 then 1 else 0 end as organdonor
	from eicu_crd.patient
)

-- Patients unitvisitnumber (original and revised)
, unitvisitnumbersrevised as 
(
select pa.uniquepid, pa.patienthealthsystemstayid, pa.patientunitstayid, pa.unitvisitnumber 
	, pa.unitvisitnumber - min_visit.min_num + 1 as unitvisitnumberrevised
from eicu_crd.patient pa
left join (
select uniquepid, patienthealthsystemstayid, min(unitvisitnumber) as min_num 
from eicu_crd.patient
group by uniquepid, patienthealthsystemstayid
) min_visit on min_visit.uniquepid = pa.uniquepid and min_visit.patienthealthsystemstayid = pa.patienthealthsystemstayid
)


-- lab events for the First 24 hours after ICU admission
, lab_events as 
(
	
SELECT
  pvt.uniquepid, pvt.patienthealthsystemstayid, pvt.patientunitstayid
  , min(CASE WHEN labname = 'bicarbonate' THEN labresult ELSE null END) as BICARBONATE_min
  , max(CASE WHEN labname = 'bicarbonate' THEN labresult ELSE null END) as BICARBONATE_max
  , min(CASE WHEN labname = 'total bilirubin' THEN labresult ELSE null END) as BILIRUBIN_min
  , max(CASE WHEN labname = 'total bilirubin' THEN labresult ELSE null END) as BILIRUBIN_max
  , min(CASE WHEN labname = 'potassium' THEN labresult ELSE null END) as POTASSIUM_min
  , max(CASE WHEN labname = 'potassium' THEN labresult ELSE null END) as POTASSIUM_max
  , min(CASE WHEN labname = 'sodium' THEN labresult ELSE null end) as SODIUM_min
  , max(CASE WHEN labname = 'sodium' THEN labresult ELSE null end) as SODIUM_max
  , min(CASE WHEN labname = 'BUN' THEN labresult ELSE null end) as BUN_min
  , max(CASE WHEN labname = 'BUN' THEN labresult ELSE null end) as BUN_max
  , min(CASE WHEN labname = 'WBC x 1000' THEN labresult ELSE null end) as WBC_min
  , max(CASE WHEN labname = 'WBC x 1000' THEN labresult ELSE null end) as WBC_max
  
FROM
( -- begin query that extracts the data
  SELECT p.uniquepid, p.patienthealthsystemstayid, p.patientunitstayid, le.labname

  -- add in some sanity checks on the values; same checks from original MIMIC version
  -- the where clause below requires all labresult to be > 0, so these are only upper limit checks
  , CASE
     WHEN labname = 'bicarbonate' and le.labresult > 10000 THEN null -- mEq/L 'BICARBONATE'
     WHEN labname = 'total bilirubin' and le.labresult >   150 THEN null -- mg/dL 'BILIRUBIN'
     WHEN labname = 'potassium' and le.labresult >    30 THEN null -- mEq/L 'POTASSIUM'
     WHEN labname = 'sodium' and le.labresult >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
     WHEN labname = 'BUN' and le.labresult >   300 THEN null -- 'BUN'
     WHEN labname = 'WBC x 1000' and le.labresult >  1000 THEN null -- 'WBC'
   ELSE le.labresult
   END AS labresult

  FROM eicu_crd.patient p

  LEFT JOIN eicu_crd.lab le
    ON p.patientunitstayid = le.patientunitstayid
    AND le.labresultoffset <= 1440 -- First 24 hours after ICU admission
	and le.labresultoffset >= -1440 -- First 24 hours before ICU admission
    AND le.labname in
    (
    	'bicarbonate',
    	'total bilirubin',
    	'potassium',
    	'sodium',
    	'BUN',
    	'WBC x 1000'
    )
    AND labresult IS NOT null AND labresult > 0 -- lab values cannot be 0 and cannot be negative
) pvt
GROUP BY pvt.uniquepid, pvt.patienthealthsystemstayid, pvt.patientunitstayid
)


-- Nurse charting events raw for the First 24 hours after ICU admission
, nursecharting_events_raw as (
SELECT
  pnc.uniquepid, pnc.patienthealthsystemstayid, pnc.patientunitstayid, pnc.nursingChartOffset
  , min(case
      when nursingchartcelltypevallabel = 'Glasgow coma score'
       and nursingchartcelltypevalname = 'GCS Total'
      -- and lower(nursingchartvalue) ~ '^[-]?[0-9]+[.]?[0-9]*$'
      -- and nursingchartvalue not in ('-','.')
          then cast(nursingchartvalue as numeric)
      when nursingchartcelltypevallabel = 'Score (Glasgow Coma Scale)'
       and nursingchartcelltypevalname = 'Value'
      -- and lower(nursingchartvalue) ~ '^[-]?[0-9]+[.]?[0-9]*$'
      -- and nursingchartvalue not in ('-','.')
          then cast(nursingchartvalue as numeric)
      else null end)
    as gcs
  , max(CASE WHEN nursingChartCellTypeValName = 'Heart Rate' THEN nursingChartValue ELSE null END) as hr
  , max(CASE WHEN nursingChartCellTypeValName = 'Temperature (C)' THEN nursingChartValue ELSE null END) as temperature
  , max(CASE WHEN nursingChartCellTypeValName = 'Non-Invasive BP Systolic' THEN nursingChartValue ELSE null END) as nisbp
  , max(CASE WHEN nursingChartCellTypeValName = 'Invasive BP Systolic'	THEN nursingChartValue ELSE null END) as isbp
	
FROM
	
( -- begin query that extracts the data
  SELECT p.uniquepid, p.patienthealthsystemstayid, p.patientunitstayid, nc.nursingChartCellTypeValLabel, nc.nursingChartOffset
	, nc.nursingChartCellTypeValName

  -- add in some sanity checks on the values; same checks from original MIMIC version
  -- the where clause below requires all labresult to be > 0, so these are only upper limit checks
  , cast(nursingChartValue as DOUBLE PRECISION) as nursingChartValue

  FROM eicu_crd.patient p

  LEFT JOIN eicu_crd.nursecharting nc
    ON p.patientunitstayid = nc.patientunitstayid
    AND nc.nursingChartOffset <= 1440 -- First 24 hours after ICU admission
    AND nc.nursingChartOffset >= 0  
    AND( nc.nursingChartCellTypeValName in
    (
    	'GCS Total'  -- sanity check : 2 < gcs < 16
		,'Heart Rate'  --- sanity check : hr<300
		,'Temperature (C)'   -- sanity check : entre 10 et 50
		,'Temperature (F)' 
		,'Non-Invasive BP Systolic' 
		,'Invasive BP Systolic' -- sanity check : 0<sbd<400  -- On ne le considere pas pour l'instant
	)
	OR (nursingchartcelltypevallabel = 'Score (Glasgow Coma Scale)'
       and nursingchartcelltypevalname = 'Value'))
    AND nursingChartValue IS NOT null AND nursingChartValue ~ '^[-]?[0-9]+[.]?[0-9]*$' 
	AND cast(nursingChartValue as DOUBLE PRECISION) > 0 -- values cannot be 0 and cannot be negative
) pnc
GROUP BY pnc.uniquepid, pnc.patienthealthsystemstayid, pnc.patientunitstayid, pnc.nursingChartOffset
)


-- Nurse charting events for the First 24 hours after ICU admission
, nursecharting_events as 
(
 select uniquepid, patienthealthsystemstayid, patientunitstayid, nursingchartoffset
	, case when gcs not between 3 and 15 then null else gcs end as gcs
	, case when hr between 1 and 24 then null 
		when hr > 250 then null else hr end as hr
	, round(cast(case when temperature between 60 and 130 then (temperature - 32) * 5 / 9 -- Fahrenheit to celcius conversion
		when temperature > 120 then null 
		when temperature > 0 and temperature < 25 then null else temperature end as numeric), 1) as temperature
	, case when nisbp > 250 or nisbp < 30 then null else nisbp end as nisbp
	, case when isbp > 250 or isbp < 30 then null else isbp end as isbp
from nursecharting_events_raw
)
-- worst values for nursecharting events for the First 24 hours after ICU admission
, nursecharting_events_minmax as 
(
	SELECT
  			nc.uniquepid, nc.patienthealthsystemstayid, nc.patientunitstayid
			, min(gcs) as gcs_min
			, min(hr) as hr_min
			, max(hr) as hr_max
			, min(temperature) as temperature_min
			, max(temperature) as temperature_max
			, min(nisbp) as nisbp_min
			, max(nisbp) as nisbp_max
			, min(isbp) as isbp_min
			, max(isbp) as isbp_max
			
	from nursecharting_events nc
	group by nc.uniquepid, nc.patienthealthsystemstayid, nc.patientunitstayid
)

-- Urine ouput for the first 24 hours after admission
, uo_24 as (
select patientunitstayid, urineoutput from eicu_crd.firstday_uo
)


-- There seems to be some contradictions about GCS, to investigate with the 2 obtained variables
, gcs_rev as 
(
select distinct patientunitstayid, min(motor + eye + verbal) as gcs from (
select distinct patientunitstayid, physicalexamoffset  
, min(case when lower(physicalexampath) like '%motor score%' then cast(physicalexamvalue as integer) end)  as motor
, min(case when lower(physicalexampath) like '%eyes score%' then cast(physicalexamvalue as integer) end) as eye
, min(case when lower(physicalexampath) like '%verbal score%' then cast(physicalexamvalue as integer) end) as verbal
from eicu_crd.physicalexam
where physicalexampath like '%GCS%' and physicalexamoffset between 0 and 1440
group by 1, 2 )t group by 1
)


-- chronic disease of patients from icd9 codes
, chronic_disease as (

SELECT patientunitstayid
, MAX(CASE
    WHEN icd9code like '%042%' or icd9code like '%V08%'  --SUBSTR(icd9code, 1, 3) BETWEEN '042' AND '044'
      THEN 1
    ELSE 0 END) AS aids  /* HIV and AIDS */
  , MAX(
    CASE 
	  	WHEN lower(diagnosisstring) like '%leukemia%' THEN 1 -- Hematology
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20000' AND '20238' THEN 1 -- lymphoma
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20240' AND '20248' THEN 1 -- leukemia
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20250' AND '20302' THEN 1 -- lymphoma
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20310' AND '20312' THEN 1 -- leukemia
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20302' AND '20382' THEN 1 -- lymphoma
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20400' AND '20522' THEN 1 -- chronic leukemia
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20580' AND '20702' THEN 1 -- other myeloid leukemia
        WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20720' AND '20892' THEN 1 -- other myeloid leukemia
        WHEN SUBSTR(icd9code, 1, 4) IN ('2386', '2733') then 1 -- lymphoma   
  ELSE 0 END) as hem         /* Hematologic malignancy */
  , MAX(CASE
	  WHEN lower(diagnosisstring) like '%metastatic%' THEN 1
      WHEN SUBSTR(icd9code, 1, 4) BETWEEN '1960' AND '1991' THEN 1
      WHEN SUBSTR(icd9code, 1, 5) BETWEEN '20970' AND '20975' THEN 1
      WHEN SUBSTR(icd9code, 1, 5) IN ('20979', '78951') THEN 1
      ELSE 0 END ) as mets      /* Metastatic cancer */

FROM eicu_crd.diagnosis
group by patientunitstayid
--where SUBSTR(icd9code, 1, 5) between '20000' AND '20238'
order by patientunitstayid
	)

-- Admission type
, admission_type as (
select patientunitstayid, 
	case when elective = 1 and surgical = 1 then 0 --'ScheduledSurgical'
		 when elective = 0 and surgical = 1 then 8 --'UnscheduledSurgical'
		 else 6 --'Medical'
	end as AdmissionType
from (
select distinct patientunitstayid
	, max(case when lower(admitdxpath) like '%elective|yes%' then 1 else 0 end) as elective
	, max(case when lower(admitdxname) like '%surg%' then 1 else 0 end) as surgical  
	
from eicu_crd.admissiondx
group by patientunitstayid
) admtype
)

, pao2fio2vals as (
select distinct patientunitstayid, min(pao2/fio2) as pao2fio2, max(cpap) as cpap, max(vent) as vent
from eicu_crd.pao2sao2fio2
where labresultoffset between -1440 and 1440 and fio2>0
group by patientunitstayid
)


, sepsis_vals as (
	select distinct patientunitstayid, sepsis3 from (
-- sepsis à l'admission
select distinct patientunitstayid, 1 as sepsis3 from eicu_crd.admissiondx
where lower(admitdxpath) like '%sepsis%' or lower(admitdxpath) like '%septic shock%'
union 
-- sepsis diagnostiqué après admission
SELECT distinct patientunitstayid, 1 as sepsis3 FROM eicu_crd.diagnosis
where diagnosisoffset < 1440
	and (	(icd9code like '%995.91%' or icd9code like '%995.92%') 
	or lower(diagnosisstring) like '%sepsis%'
	or lower(diagnosisstring) like '%septic shock%')
	) sepall
)


-- combination of previous tables
, comb_tables as (

	select pi.patientunitstayid
			, pi.patientHealthSystemStayID as hadm_id
			, pi.uniquepid as subject_id
			, pi.hospitalid
			, GREATEST(pi.deceased_unit, pi.deceased_hosp) as deceased
			, pi.age
			, pi.stay_length
			, pi.organdonor
			-- lab events
			, lem.BICARBONATE_min
			, lem.BICARBONATE_max
			, lem.BILIRUBIN_min
			, lem.BILIRUBIN_max
			, lem.POTASSIUM_min
			, lem.POTASSIUM_max
			, lem.SODIUM_min
			, lem.SODIUM_max
			, lem.BUN_min
			, lem.BUN_max
			, lem.WBC_min
			, lem.WBC_max
			-- pao2fio2
			, pfv.pao2fio2 as pao2fio2
			, pfv.cpap
			, pfv.vent
			-- nursecharting events
			, LEAST(gcs_min, gcsrev.gcs) as gcs_min
			, ncm.hr_min 
			, ncm.hr_max
			, temperature_min as tempc_min
			, temperature_max as tempc_max
			, case when ncm.nisbp_min is null then ncm.isbp_min else ncm.nisbp_min end as sbp_min
			, case when ncm.nisbp_max is null then ncm.isbp_max else ncm.nisbp_max end as sbp_max
			-- urine output
			, uo24.urineoutput as uo
			-- Chronic disease
			, cd.aids
			, cd.hem
			, cd.mets
			-- Admission type
			, admt.AdmissionType
			-- Sepsis3
			, case when seps.sepsis3 is null then 0 else seps.sepsis3 end as sepsis3
			--unitvisitnumber
			, uvn.unitvisitnumber
			, uvn.unitvisitnumberrevised
	
	from pat_info pi
	left join lab_events lem on pi.patientunitstayid = lem. patientunitstayid
	left join nursecharting_events_minmax ncm on pi.patientunitstayid = ncm.patientunitstayid
	left join uo_24 uo24 on pi.patientunitstayid = uo24.patientunitstayid
	left join chronic_disease cd on pi.patientunitstayid = cd.patientunitstayid
	left join admission_type admt on admt.patientunitstayid = pi.patientunitstayid
	left join pao2fio2vals pfv on pfv.patientunitstayid = pi.patientunitstayid
	left join sepsis_vals seps on seps.patientunitstayid = pi.patientunitstayid
	left join unitvisitnumbersrevised uvn on uvn.patientunitstayid = pi.patientunitstayid
	left join gcs_rev gcsrev on gcsrev.patientunitstayid = pi.patientunitstayid
)

-- Number of admissions per hospitalization
, admiss_numb as (
select distinct subject_id, hadm_id, count(*) as num_admiss from comb_tables
group by subject_id, hadm_id
)

-- Number of hospitalizations
, hosp_numb as (
select distinct subject_id, count(*) as num_hosp from admiss_numb
group by subject_id
)

select 	 ct.*
		, anum.num_admiss
		, hnum.num_hosp
from comb_tables ct
left join admiss_numb anum on anum.hadm_id = ct.hadm_id
left join hosp_numb hnum on hnum.subject_id = ct.subject_id

	
