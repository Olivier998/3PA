DROP TABLE IF EXISTS eicu_crd.pao2sao2fio2; CREATE TABLE eicu_crd.pao2sao2fio2 AS



with pivoted_resp as (
select distinct patientunitstayid, labresultoffset, max(pao2) as pao2, max(fio2) as fio2, max(sao2) as sao2 
from(
select case when tt1.patientunitstayid is null then tt2.patientunitstayid else tt1.patientunitstayid end as patientunitstayid,
	case when tt1.labresultoffset is null then tt2.labresultoffset else tt1.labresultoffset end as labresultoffset,
	tt1.pao2, tt1.fio2, tt2.sao2 from (
select
      patientunitstayid
    , labresultoffset
	,max(case when labname = 'paO2' then labresult else null end) as pao2
	,max(case when labname = 'FiO2' then 
		 (case when labresult is not null then labresult
		 		when replace(labresulttext, '%', '')  ~ '^[0-9\.]+$' then cast(replace(labresulttext, '%', '') as numeric)
		 		else null end) end)  as fio2
  from eicu_crd.lab
  where labname in
  (
       'paO2'
      ,'FiO2'
  ) 
  group by patientunitstayid, labresultoffset
		
	union  

	select patientunitstayid, respchartoffset as labresultoffset, cast(null as numeric) as pao2, 
	max(case when respchartvaluelabel = 'FiO2' then 
			 (case when respchartvalue is not null and replace(respchartvalue, '%', '')  ~ '^[0-9\.]+$' then cast(replace(respchartvalue, '%', '') as numeric)
					else null end) end)  as fio2
	from eicu_crd.respiratorycharting where respchartvaluelabel like 'FiO2%'
	group by  patientunitstayid, respchartoffset
	order by labresultoffset	
) tt1 full outer join (

select distinct patientunitstayid, observationoffset as labresultoffset, sao2 from eicu_crd.vitalperiodic
where  sao2 is not null 
	)tt2 on tt1.patientunitstayid = tt2.patientunitstayid and tt1.labresultoffset = tt2.labresultoffset
	)tt3 group by patientunitstayid, labresultoffset
)


-- cpap
, cpap as (
select distinct patientunitstayid from(
select distinct patientunitstayid from eicu_crd.treatment 
where lower(treatmentstring) like '%cpap%' and treatmentoffset < 1440
union select distinct patientunitstayid from eicu_crd.nursecharting 
	where lower(nursingchartvalue) like '%cpap%' and nursingchartoffset < 1440
union select distinct patientunitstayid from eicu_crd.respiratorycharting
	where lower(respchartvalue) like '%cpap%' and respchartoffset < 1440
) temp
)

-- mechanical ventilation
, mechvent as (
	WITH t1 AS
  (SELECT patientunitstayid,
		ventstartoffset,
		ventendoffset,
        CASE
             WHEN airwaytype IN ('Oral ETT', 'Nasal ETT', 'Tracheostomy') THEN 1
             ELSE NULL
        END AS airway -- either invasive airway or NULL
   FROM eicu_crd.respiratorycare),
     t2 AS
  (SELECT DISTINCT patientunitstayid,
					respchartoffset,
                   1 AS ventilator
   FROM eicu_crd.respiratorycharting
   WHERE lower(respchartvalue) LIKE '%vent%'
     OR lower(respchartvalue) LIKE '%bipap%'
     OR lower(respchartvalue) LIKE '%cpap%'
   GROUP BY patientunitstayid, respchartoffset),
     t3 AS
  (SELECT DISTINCT patientunitstayid,
					treatmentoffset,
                   max(CASE
                           WHEN treatmentstring IN ('pulmonary|ventilation and oxygenation|mechanical ventilation',
													'pulmonary|ventilation and oxygenation|tracheal suctioning',
													'pulmonary|ventilation and oxygenation|ventilator weaning',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|assist controlled',
													'pulmonary|radiologic procedures / bronchoscopy|endotracheal tube',
													'pulmonary|ventilation and oxygenation|oxygen therapy (> 60%)',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|tidal volume 6-10 ml/kg',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|volume controlled',
													'surgery|pulmonary therapies|mechanical ventilation',
													'pulmonary|surgery / incision and drainage of thorax|tracheostomy',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|synchronized intermittent',
													'pulmonary|surgery / incision and drainage of thorax|tracheostomy|performed during current admission for ventilatory support',
													'pulmonary|ventilation and oxygenation|ventilator weaning|active',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|pressure controlled',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|pressure support',
													'pulmonary|ventilation and oxygenation|ventilator weaning|slow',
													'surgery|pulmonary therapies|ventilator weaning',
													'surgery|pulmonary therapies|tracheal suctioning',
													'pulmonary|radiologic procedures / bronchoscopy|reintubation',
													'pulmonary|ventilation and oxygenation|lung recruitment maneuver',
													'pulmonary|surgery / incision and drainage of thorax|tracheostomy|planned',
													'surgery|pulmonary therapies|ventilator weaning|rapid',
													'pulmonary|ventilation and oxygenation|prone position',
													'pulmonary|surgery / incision and drainage of thorax|tracheostomy|conventional',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|permissive hypercapnea',
													'surgery|pulmonary therapies|mechanical ventilation|synchronized intermittent',
													'pulmonary|medications|neuromuscular blocking agent',
													'surgery|pulmonary therapies|mechanical ventilation|assist controlled',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|volume assured',
													'surgery|pulmonary therapies|mechanical ventilation|tidal volume 6-10 ml/kg',
													'surgery|pulmonary therapies|mechanical ventilation|pressure support',
													'pulmonary|ventilation and oxygenation|non-invasive ventilation',
													'pulmonary|ventilation and oxygenation|non-invasive ventilation|face mask',
													'pulmonary|ventilation and oxygenation|non-invasive ventilation|nasal mask',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|non-invasive ventilation',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|non-invasive ventilation|face mask',
													'surgery|pulmonary therapies|non-invasive ventilation',
													'surgery|pulmonary therapies|non-invasive ventilation|face mask',
													'pulmonary|ventilation and oxygenation|mechanical ventilation|non-invasive ventilation|nasal mask',
													'surgery|pulmonary therapies|non-invasive ventilation|nasal mask',
													'surgery|pulmonary therapies|mechanical ventilation|non-invasive ventilation',
													'surgery|pulmonary therapies|mechanical ventilation|non-invasive ventilation|face mask') THEN 1
                           ELSE NULL
                       END) AS interface -- either ETT/NiV or NULL
FROM eicu_crd.treatment
   GROUP BY patientunitstayid, treatmentoffset),
-- nursecharting also contains info on O2 admin devices
	t4 AS
	( SELECT DISTINCT
		patientunitstayid,
		nursingChartOffset,
		1 AS ventilator
		FROM eicu_crd.nursecharting
		WHERE (
			nursingchartcelltypevallabel = 'O2 Admin Device'
        	-- AND in the next line *should* yield the same result, but out of caution we use OR.
    		OR  nursingchartcelltypevalname = 'O2 Admin Device'
		) AND nursingchartvalue IN (
			-- This list is not exhaustive. We should probably check it with KC See
			'ventilator',
			'vent',
			'trach collar',
			'ETT oral'
		)
	)
-- Select those ventilation sessions that were mechanically ventilated
SELECT DISTINCT t1.patientunitstayid
FROM t1
LEFT OUTER JOIN t2 ON t2.patientunitstayid=t1.patientunitstayid
LEFT OUTER JOIN t3 ON t3.patientunitstayid=t1.patientunitstayid
LEFT OUTER JOIN t4 ON t4.patientunitstayid=t1.patientunitstayid
WHERE t1.airway IS NOT NULL and t1.ventstartoffset <= 1440
  OR (t2.ventilator IS NOT NULL AND t2.respchartoffset BETWEEN t1.ventstartoffset AND t1.ventendoffset)
  OR (t3.interface IS NOT NULL AND t3.treatmentoffset BETWEEN t1.ventstartoffset AND t1.ventendoffset)
	OR (t4.ventilator IS NOT NULL AND t4.nursingChartOffset BETWEEN t1.ventstartoffset AND t1.ventendoffset)
)


select tt3.patientunitstayid, labresultoffset, pao2, sao2, fio2,
case when cpap.patientunitstayid is not null then 1 else 0 end as cpap,
case when mechvent.patientunitstayid is not null then 1 else 0 end as vent

from (
select patientunitstayid, labresultoffset, pao2, sao2, case when fio2 > 0 and fio2 <=1 then fio2 when fio2 >=20 and fio2 <= 100 then fio2/100 else null end as fio2
from(
select patientunitstayid, labresultoffset, pao2, sao2 , first_value(fio2) OVER (PARTITION BY patientunitstayid, grp ORDER BY labresultoffset) AS fio2
from (
select patientunitstayid, labresultoffset, pao2, sao2, fio2
 ,count(fio2) OVER (PARTITION BY patientunitstayid ORDER BY labresultoffset) AS grp
from pivoted_resp
)tt1
)tt2
where (sao2 is not null or pao2 is not null)
) tt3
left outer join cpap on cpap.patientunitstayid = tt3.patientunitstayid
left outer join mechvent on mechvent.patientunitstayid = tt3.patientunitstayid

